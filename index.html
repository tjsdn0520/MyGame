<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Joker Game (Final Rule)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #27ae60; color: white; font-family: 'Arial', sans-serif; text-align: center; margin: 0; overflow: hidden; }
        
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; }
        .active { display: flex; }

        #game-table { position: relative; width: 100%; height: 100%; max-width: 800px; margin: 0 auto; }
        
        /* í”Œë ˆì´ì–´ ì˜ì—­ */
        .player-area { position: absolute; width: 220px; transition: 0.3s; padding: 10px; border-radius: 10px; }
        #p-me    { bottom: 20px; left: 50%; transform: translateX(-50%); } 
        #p-next  { right: 20px; top: 50%; transform: translateY(-50%); } 
        #p-top   { top: 20px; left: 50%; transform: translateX(-50%); } 
        #p-prev  { left: 20px; top: 50%; transform: translateY(-50%); } 

        .cards-row { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; min-height: 80px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            width: 50px; height: 75px; background: white; border-radius: 5px; color: black;
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); border: 2px solid #ccc; user-select: none;
        }
        .card.joker { color: red; }
        .card.back { background: repeating-linear-gradient(45deg, #e74c3c, #e74c3c 10px, #c0392b 10px, #c0392b 20px); color: transparent; }
        
        /* í„´ & íƒ€ê²Ÿ ê°•ì¡° */
        .turn-active { border: 4px solid #f1c40f; box-shadow: 0 0 20px #f1c40f; background: rgba(0,0,0,0.3); }
        .target-active .card.back { cursor: pointer; border: 2px solid yellow; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        .target-badge { display: none; background: red; color: white; padding: 2px 8px; border-radius: 5px; font-size: 12px; margin-left: 5px; }
        .target-active .target-badge { display: inline-block; }

        .nickname { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .msg-box { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; pointer-events: none; z-index: 50; }

        /* [NEW] ì¹´ë“œ ë½‘ê¸° ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
        #draw-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #drawn-card-display {
            width: 150px; height: 225px; font-size: 60px; 
            transform: scale(0.5); opacity: 0; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #draw-overlay.show #drawn-card-display { transform: scale(1); opacity: 1; }
        #draw-text { margin-top: 20px; font-size: 24px; opacity: 0; transition: 0.5s 0.3s; }
        #draw-overlay.show #draw-text { opacity: 1; }

    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>ğŸ¤¡ ì¡°ì»¤ ë½‘ê¸° (ì™„ì „íŒ)</h1>
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="padding:10px;">
        <button onclick="joinGame()" style="padding:10px 20px; margin-top:10px;">ì°¸ê°€</button>
        <p id="wait-msg" style="display:none;">4ëª… ëª¨ìœ¼ëŠ” ì¤‘... (<span id="count">0</span>/4)</p>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-table">
            <div class="msg-box" id="status-msg">ê²Œì„ ì‹œì‘! í˜ì–´ë¥¼ ë²„ë¦½ë‹ˆë‹¤.</div>

            <div id="p-top" class="player-area"><div class="nickname" id="name-top">P2</div><div class="cards-row" id="hand-top"></div></div>
            <div id="p-prev" class="player-area"><div class="nickname" id="name-prev">P3</div><div class="cards-row" id="hand-prev"></div></div>
            <div id="p-next" class="player-area"><div class="nickname" id="name-next">P1</div><div class="cards-row" id="hand-next"></div></div>
            <div id="p-me" class="player-area"><div class="nickname" id="name-me">ë‚˜</div><div class="cards-row" id="hand-me"></div></div>
        </div>
    </div>

    <div id="draw-overlay">
        <div id="drawn-card-display" class="card">?</div>
        <div id="draw-text">ì¹´ë“œë¥¼ ë½‘ì•˜ìŠµë‹ˆë‹¤!</div>
    </div>

    <div id="screen-end" class="screen">
        <h1 style="font-size: 50px; color:red;">ğŸ¤¡ ê²Œì„ ì¢…ë£Œ ğŸ¤¡</h1>
        <h2 id="loser-name" style="color: yellow;"></h2>
        <button onclick="location.reload()" style="padding:15px; margin-top: 20px;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <script>
        const socket = io();
        let myRoom = null;
        let myIndex = -1;
        let playerNames = [];
        let isMyTurn = false;
        let currentTargetIdx = -1; // í˜„ì¬ ë‚´ê°€ ë½‘ì•„ì•¼ í•  íƒ€ê²Ÿ ì¸ë±ìŠ¤
        
        // [ì¤‘ìš”] ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ë°©ì§€ í”Œë˜ê·¸
        let isAnimating = false; 
        let pendingState = null; // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë„ì°©í•œ ìµœì‹  ìƒíƒœ ì €ì¥

        function joinGame() {
            const nick = document.getElementById('nickname').value || 'ìµëª…';
            socket.emit('join_game', nick);
            document.getElementById('wait-msg').style.display = 'block';
            document.querySelector('button').disabled = true;
        }
        socket.on('waiting_status', (count) => document.getElementById('count').innerText = count);

        socket.on('game_start', (data) => {
            myRoom = data.roomID;
            myIndex = data.myIndex;
            playerNames = data.players;
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            setNames();
        });

        // ì„œë²„ë¡œë¶€í„° ì „ì²´ ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ë°›ìŒ
        socket.on('state_update', (data) => {
            // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ë©´ ë‚˜ì¤‘ì— ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì €ì¥ë§Œ í•´ë‘ 
            if(isAnimating) {
                pendingState = data;
                return;
            }
            renderGameState(data);
        });

        // [NEW] ì¹´ë“œ ë½‘ê¸° ì—°ì¶œ ì‹ í˜¸ ë°›ìŒ
        socket.on('card_drawn_animate', (data) => {
            isAnimating = true; // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            const overlay = document.getElementById('draw-overlay');
            const cardDisp = document.getElementById('drawn-card-display');
            
            cardDisp.innerText = data.card;
            cardDisp.className = data.card === 'ğŸ¤¡' ? 'card joker' : 'card';
            
            overlay.style.display = 'flex';
            // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
            setTimeout(() => overlay.classList.add('show'), 50);

            // 2ì´ˆ í›„ ì—°ì¶œ ì¢…ë£Œ
            setTimeout(() => {
                overlay.classList.remove('show');
                setTimeout(() => overlay.style.display = 'none', 300); // fade out ê¸°ë‹¤ë¦¼

                isAnimating = false; // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
                // ë°€ë ¤ìˆë˜ ìµœì‹  ìƒíƒœê°€ ìˆìœ¼ë©´ ë°˜ì˜ (í˜ì–´ê°€ ì œê±°ëœ ìƒíƒœ)
                if(pendingState) {
                    renderGameState(pendingState);
                    pendingState = null;
                }
            }, 2000);
        });

        socket.on('action_log', (data) => document.getElementById('status-msg').innerText = data.msg);

        socket.on('game_over', (data) => {
            document.getElementById('screen-game').style.display = 'none';
            document.getElementById('screen-end').classList.add('active');
            document.getElementById('loser-name').innerText = `íŒ¨ë°°ì: ${data.loser} (ì¡°ì»¤ ë³´ìœ )`;
        });

        // ê²Œì„ ìƒíƒœ í™”ë©´ì— ê·¸ë¦¬ê¸°
        function renderGameState(data) {
            isMyTurn = (data.turnIndex === myIndex);
            
            if(isMyTurn) document.getElementById('status-msg').innerText = "ë‚´ ì°¨ë¡€! ë¹›ë‚˜ëŠ” ì¹´ë“œë¥¼ ë½‘ìœ¼ì„¸ìš”.";
            else document.getElementById('status-msg').innerText = `${playerNames[data.turnIndex]}ë‹˜ì˜ ì°¨ë¡€...`;

            resetHighlights();
            highlightPlayer(data.turnIndex, 'turn-active');

            // íƒ€ê²Ÿ ì°¾ê¸°: ë‚´ ì˜¤ë¥¸ìª½ë¶€í„° ì¹´ë“œê°€ ìˆëŠ” ì²« ë²ˆì§¸ ì‚¬ëŒ
            currentTargetIdx = -1;
            if(isMyTurn && data.playerCounts[myIndex] > 0) { // ë‚˜ë„ ì¹´ë“œê°€ ìˆì–´ì•¼ í„´ ì§„í–‰ ê°€ëŠ¥
                let tempIdx = (myIndex + 1) % 4;
                while(data.playerCounts[tempIdx] === 0 && tempIdx !== myIndex) {
                    tempIdx = (tempIdx + 1) % 4;
                }
                if(data.playerCounts[tempIdx] > 0 && tempIdx !== myIndex) {
                     currentTargetIdx = tempIdx;
                     highlightPlayer(currentTargetIdx, 'target-active');
                }
            }

            // ë‚´ ì¹´ë“œ ê·¸ë¦¬ê¸°
            const myHandDiv = document.getElementById('hand-me');
            myHandDiv.innerHTML = '';
            if(data.myHand.length === 0) myHandDiv.innerHTML = '<span style="color:#aaa;">íƒˆì¶œ ì™„ë£Œ!</span>';
            data.myHand.forEach(card => {
                const div = document.createElement('div');
                div.className = card === 'ğŸ¤¡' ? 'card joker' : 'card';
                div.innerText = card;
                myHandDiv.appendChild(div);
            });

            // ìƒëŒ€ íŒ¨ ê·¸ë¦¬ê¸°
            [1, 2, 3].forEach(offset => {
                const idx = (myIndex + offset) % 4;
                renderOpponentHand(idx, data.playerCounts[idx], (isMyTurn && currentTargetIdx === idx));
            });
        }

        function setNames() {
            const p = playerNames;
            document.getElementById('name-me').innerText = p[myIndex];
            document.getElementById('name-next').innerHTML = p[(myIndex + 1)%4] + ' <span class="target-badge">PICK</span>';
            document.getElementById('name-top').innerHTML = p[(myIndex + 2)%4] + ' <span class="target-badge">PICK</span>';
            document.getElementById('name-prev').innerHTML = p[(myIndex + 3)%4] + ' <span class="target-badge">PICK</span>';
        }

        function highlightPlayer(idx, className) {
            const offsets = [0, 1, 2, 3]; // me, next, top, prev
            const targetOffset = (idx - myIndex + 4) % 4;
            const ids = ['p-me', 'p-next', 'p-top', 'p-prev'];
            document.getElementById(ids[targetOffset]).classList.add(className);
        }

        function resetHighlights() {
            ['p-me', 'p-next', 'p-top', 'p-prev'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('turn-active');
                el.classList.remove('target-active');
            });
        }

        function renderOpponentHand(idx, count, isClickable) {
            const offsets = [0, 1, 2, 3];
            const targetOffset = (idx - myIndex + 4) % 4;
            const ids = ['p-me', 'p-next', 'p-top', 'p-prev'];
            const container = document.getElementById(ids[targetOffset].replace('p-', 'hand-'));
            
            container.innerHTML = '';
            if(count === 0) {
                container.innerHTML = '<span style="color:#aaa;">íƒˆì¶œ!</span>';
                return;
            }
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = 'card back';
                div.innerText = "?";
                if(isClickable) {
                    div.onclick = () => pickCard(idx, i);
                    div.style.cursor = 'pointer';
                } else {
                    div.style.cursor = 'default';
                }
                container.appendChild(div);
            }
        }

        function pickCard(targetIdx, cardIdx) {
            if(!isMyTurn || isAnimating) return;
            // ì„œë²„ì— íƒ€ê²Ÿ ì¸ë±ìŠ¤ë„ ê°™ì´ ë³´ëƒ„
            socket.emit('draw_card', { roomID: myRoom, targetIndex: targetIdx, cardIndex: cardIdx });
            isMyTurn = false;
        }
    </script>
</body>
</html>