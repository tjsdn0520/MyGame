<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Rock Paper Scissors Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            background-color: #2c3e50; color: white; font-family: 'Arial', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; user-select: none;
        }
        h1 { margin-bottom: 20px; font-size: 3rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        /* 화면 전환용 */
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .active { display: flex; }

        /* 버튼 스타일 */
        .btn {
            background: #e74c3c; color: white; border: none; padding: 15px 40px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn:hover { transform: scale(1.05); background: #c0392b; }

        /* 카드 스타일 */
        .cards-container { display: flex; gap: 20px; margin-top: 30px; }
        .card {
            background: white; border-radius: 15px; width: 120px; height: 160px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; border: 5px solid transparent; color: #333;
        }
        .card:hover { transform: translateY(-10px); border-color: #f1c40f; }
        .card.selected { background: #f1c40f; border-color: #fff; transform: scale(1.1); }
        .card.disabled { opacity: 0.5; pointer-events: none; }
        
        .emoji { font-size: 4rem; }
        .label { font-size: 1.2rem; font-weight: bold; margin-top: 10px; }

        /* 타이머 바 */
        #timer-box { width: 300px; height: 20px; background: #555; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: #2ecc71; transition: width 1s linear; }

        /* 결과 화면 */
        #result-msg { font-size: 3rem; font-weight: bold; margin: 20px; }
        .win { color: #2ecc71; }
        .lose { color: #e74c3c; }
        .draw { color: #f1c40f; }
        
        #opponent-choice { font-size: 5rem; margin: 20px; }
    </style>
</head>
<body>

    <div id="screen-start" class="screen active">
        <h1>가위 바위 보</h1>
        <button class="btn" onclick="joinGame()">게임 찾기</button>
    </div>

    <div id="screen-wait" class="screen">
        <h1>매칭 중...</h1>
        <p>상대방이 접속할 때까지 잠시만 기다려주세요.</p>
        <div class="emoji">⏳</div>
    </div>

    <div id="screen-game" class="screen">
        <h2 id="status-text">카드를 선택하세요!</h2>
        
        <div id="timer-box"><div id="timer-bar"></div></div>
        <p id="time-text">남은 시간: 10초</p>

        <div class="cards-container" id="cards">
            <div class="card" onclick="selectCard('scissors')">
                <div class="emoji">✌️</div>
                <div class="label">가위</div>
            </div>
            <div class="card" onclick="selectCard('rock')">
                <div class="emoji">✊</div>
                <div class="label">바위</div>
            </div>
            <div class="card" onclick="selectCard('paper')">
                <div class="emoji">✋</div>
                <div class="label">보</div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <h1 id="result-title">결과</h1>
        <p>상대방의 선택:</p>
        <div id="opponent-choice">❓</div>
        <div id="result-msg"></div>
        <button class="btn" onclick="location.reload()">다시 하기</button>
    </div>

    <script>
        const socket = io();
        let currentRoom = null;
        let myTimer = null;
        let timeLeft = 10;

        // 화면 전환 함수
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // 게임 찾기
        function joinGame() {
            showScreen('screen-wait');
            socket.emit('join_game');
        }

        // 게임 시작 (서버에서 신호 옴)
        socket.on('game_start', (data) => {
            currentRoom = data.roomID;
            showScreen('screen-game');
            startTimer();
        });

        // 결과 수신
        socket.on('game_result', (data) => {
            clearInterval(myTimer); // 타이머 멈춤
            showScreen('screen-result');

            const resultTitle = document.getElementById('result-title');
            const resultMsg = document.getElementById('result-msg');
            const opChoice = document.getElementById('opponent-choice');

            // 상대방 선택 표시
            if(data.opponentMove === 'rock') opChoice.innerText = '✊';
            else if(data.opponentMove === 'paper') opChoice.innerText = '✋';
            else if(data.opponentMove === 'scissors') opChoice.innerText = '✌️';
            else if(data.opponentMove === 'timeout') opChoice.innerText = '⏰'; // 상대 시간초과
            else opChoice.innerText = '❓';

            // 결과 메시지
            if (data.result === 'win') {
                resultMsg.innerText = "승리!";
                resultMsg.className = 'win';
            } else if (data.result === 'lose') {
                resultMsg.innerText = data.msg || "패배...";
                resultMsg.className = 'lose';
            } else {
                resultMsg.innerText = "무승부!";
                resultMsg.className = 'draw';
            }
        });

        // 카드 선택
        function selectCard(choice) {
            // 서버에 전송
            socket.emit('make_move', { roomID: currentRoom, choice: choice });

            // UI 업데이트 (선택 완료 상태)
            document.getElementById('status-text').innerText = "상대방을 기다리는 중...";
            
            // 모든 카드 비활성화 및 선택 효과
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => {
                c.classList.add('disabled'); // 클릭 방지
                if(c.onclick.toString().includes(choice)) {
                    c.classList.add('selected'); // 선택된 카드 표시
                }
            });
        }

        // 클라이언트 측 타이머 (시각적 용도)
        function startTimer() {
            timeLeft = 10;
            const timerBar = document.getElementById('timer-bar');
            const timeText = document.getElementById('time-text');
            
            timerBar.style.width = '100%';
            timeText.innerText = `남은 시간: ${timeLeft}초`;

            myTimer = setInterval(() => {
                timeLeft--;
                timeText.innerText = `남은 시간: ${timeLeft}초`;
                timerBar.style.width = `${(timeLeft / 10) * 100}%`;

                if (timeLeft <= 0) {
                    clearInterval(myTimer);
                }
            }, 1000);
        }
    </script>
</body>
</html>