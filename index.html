<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Joker Game (Fixed)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #27ae60; color: white; font-family: 'Arial', sans-serif; text-align: center; margin: 0; overflow: hidden; }
        
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; }
        .active { display: flex; }

        #game-table { position: relative; width: 100%; height: 100%; max-width: 800px; margin: 0 auto; }
        
        /* í”Œë ˆì´ì–´ ë°°ì¹˜ */
        .player-area { position: absolute; width: 220px; transition: 0.3s; padding: 10px; border-radius: 10px; }
        #p-me    { bottom: 20px; left: 50%; transform: translateX(-50%); } 
        #p-next  { right: 20px; top: 50%; transform: translateY(-50%); } 
        #p-top   { top: 20px; left: 50%; transform: translateX(-50%); } 
        #p-prev  { left: 20px; top: 50%; transform: translateY(-50%); } 

        .cards-row { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; min-height: 80px; }
        
        .card { 
            width: 50px; height: 75px; background: white; border-radius: 5px; color: black;
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); border: 2px solid #ccc; user-select: none;
        }
        .card.back { background: repeating-linear-gradient(45deg, #e74c3c, #e74c3c 10px, #c0392b 10px, #c0392b 20px); color: transparent; }
        
        /* ë‚´ í„´ & íƒ€ê²Ÿ í‘œì‹œ */
        .turn-active { border: 4px solid #f1c40f; box-shadow: 0 0 20px #f1c40f; background: rgba(0,0,0,0.3); }
        .target-active .card.back { cursor: pointer; border: 2px solid yellow; }
        .target-active .card.back:hover { transform: translateY(-10px); }
        
        /* íƒ€ê²Ÿ ë±ƒì§€ */
        .target-badge { display: none; background: red; color: white; padding: 2px 8px; border-radius: 5px; font-size: 12px; margin-left: 5px; }
        .target-active .target-badge { display: inline-block; }

        .nickname { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .msg-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 15px 30px; border-radius: 20px; pointer-events: none; z-index: 100; font-size: 20px; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>ğŸ¤¡ ì¡°ì»¤ ë½‘ê¸°</h1>
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="padding:10px;">
        <button onclick="joinGame()" style="padding:10px 20px; margin-top:10px;">ì°¸ê°€</button>
        <p id="wait-msg" style="display:none;">ëŒ€ê¸° ì¤‘... (<span id="count">0</span>/4)</p>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-table">
            <div class="msg-box" id="status-msg">ê²Œì„ ì‹œì‘!</div>

            <div id="p-top" class="player-area">
                <div class="nickname" id="name-top">P2 <span class="target-badge">TARGET</span></div>
                <div class="cards-row" id="hand-top"></div>
            </div>
            <div id="p-prev" class="player-area">
                <div class="nickname" id="name-prev">P3 <span class="target-badge">TARGET</span></div>
                <div class="cards-row" id="hand-prev"></div>
            </div>
            <div id="p-next" class="player-area">
                <div class="nickname" id="name-next">P1 <span class="target-badge">TARGET</span></div>
                <div class="cards-row" id="hand-next"></div>
            </div>
            <div id="p-me" class="player-area">
                <div class="nickname" id="name-me">ë‚˜</div>
                <div class="cards-row" id="hand-me"></div>
            </div>
        </div>
    </div>

    <div id="screen-end" class="screen">
        <h1 style="font-size: 50px;">ê²Œì„ ì¢…ë£Œ</h1>
        <h2 id="loser-name" style="color: yellow;">íŒ¨ë°°ì: ???</h2>
        <button onclick="location.reload()" style="padding:15px;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <script>
        const socket = io();
        let myRoom = null;
        let myIndex = -1;
        let playerNames = [];
        let isMyTurn = false;

        function joinGame() {
            const nick = document.getElementById('nickname').value || 'ìµëª…';
            socket.emit('join_game', nick);
            document.getElementById('wait-msg').style.display = 'block';
            document.querySelector('button').disabled = true;
        }

        socket.on('waiting_status', (count) => { document.getElementById('count').innerText = count; });

        socket.on('game_start', (data) => {
            myRoom = data.roomID;
            myIndex = data.myIndex;
            playerNames = data.players;

            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');

            const nextIdx = (myIndex + 1) % 4;
            const topIdx = (myIndex + 2) % 4;
            const prevIdx = (myIndex + 3) % 4;

            document.getElementById('name-me').innerText = playerNames[myIndex] + " (ë‚˜)";
            document.getElementById('name-next').innerHTML = playerNames[nextIdx] + ' <span class="target-badge">PICK!</span>';
            document.getElementById('name-top').innerHTML = playerNames[topIdx] + ' <span class="target-badge">PICK!</span>';
            document.getElementById('name-prev').innerHTML = playerNames[prevIdx] + ' <span class="target-badge">PICK!</span>';
        });

        socket.on('state_update', (data) => {
            isMyTurn = (data.turnIndex === myIndex);
            
            // ìƒíƒœ ë©”ì‹œì§€
            if(isMyTurn) document.getElementById('status-msg').innerText = "ë‚´ ì°¨ë¡€! ì¹´ë“œë¥¼ ë½‘ìœ¼ì„¸ìš”.";
            else document.getElementById('status-msg').innerText = `${playerNames[data.turnIndex]}ë‹˜ì˜ ì°¨ë¡€...`;

            // 1. í„´ í‘œì‹œ (ëˆ„êµ¬ ì°¨ë¡€ì¸ì§€ í…Œë‘ë¦¬)
            resetHighlights();
            const turnOwnerIdx = data.turnIndex;
            highlightPlayer(turnOwnerIdx, 'turn-active');

            // 2. íƒ€ê²Ÿ ì°¾ê¸° (ë‚´ ì°¨ë¡€ì¼ ë•Œë§Œ ìœ íš¨)
            let targetIdx = -1;
            if(isMyTurn) {
                // ë‚´ ì˜¤ë¥¸ìª½ë¶€í„° íƒìƒ‰í•´ì„œ ì¹´ë“œê°€ ìˆëŠ” ì²« ì‚¬ëŒ ì°¾ê¸°
                targetIdx = (myIndex + 1) % 4;
                while(data.playerCounts[targetIdx] === 0 && targetIdx !== myIndex) {
                    targetIdx = (targetIdx + 1) % 4;
                }
                // ì°¾ì€ íƒ€ê²Ÿ ê°•ì¡°
                highlightPlayer(targetIdx, 'target-active');
            }

            // 3. ë‚´ íŒ¨ ë Œë”ë§
            const myHandDiv = document.getElementById('hand-me');
            myHandDiv.innerHTML = '';
            data.myHand.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerText = card;
                if(card === 'ğŸ¤¡') div.style.color = 'red';
                myHandDiv.appendChild(div);
            });

            // 4. ìƒëŒ€ íŒ¨ ë Œë”ë§
            const nextIdx = (myIndex + 1) % 4;
            const topIdx = (myIndex + 2) % 4;
            const prevIdx = (myIndex + 3) % 4;

            renderOpponentHand('hand-next', data.playerCounts[nextIdx], (isMyTurn && targetIdx === nextIdx));
            renderOpponentHand('hand-top', data.playerCounts[topIdx], (isMyTurn && targetIdx === topIdx));
            renderOpponentHand('hand-prev', data.playerCounts[prevIdx], (isMyTurn && targetIdx === prevIdx));
        });

        socket.on('action_log', (data) => {
            document.getElementById('status-msg').innerText = data.msg;
        });

        socket.on('game_over', (data) => {
            document.getElementById('screen-game').style.display = 'none';
            document.getElementById('screen-end').classList.add('active');
            document.getElementById('loser-name').innerText = `íŒ¨ë°°ì: ${data.loser} (ì¡°ì»¤)`;
        });

        // í”Œë ˆì´ì–´ ID(0~3)ë¥¼ UI IDë¡œ ë³€í™˜í•˜ì—¬ í´ë˜ìŠ¤ ì¶”ê°€
        function highlightPlayer(idx, className) {
            let id = '';
            if(idx === myIndex) id = 'p-me';
            else if(idx === (myIndex + 1) % 4) id = 'p-next';
            else if(idx === (myIndex + 2) % 4) id = 'p-top';
            else id = 'p-prev';
            document.getElementById(id).classList.add(className);
        }

        function resetHighlights() {
            document.querySelectorAll('.player-area').forEach(el => {
                el.classList.remove('turn-active');
                el.classList.remove('target-active');
            });
        }

        function renderOpponentHand(elementId, count, isClickable) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            // íƒˆì¶œí–ˆìœ¼ë©´ í‘œì‹œ
            if(count === 0) {
                container.innerHTML = '<span style="color:#aaa;">íƒˆì¶œ ì™„ë£Œ!</span>';
                return;
            }
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = 'card back';
                div.innerText = "?";
                if(isClickable) {
                    div.onclick = () => pickCard(i);
                    div.style.cursor = 'pointer';
                } else {
                    div.style.cursor = 'default';
                }
                container.appendChild(div);
            }
        }

        function pickCard(index) {
            if(!isMyTurn) return;
            socket.emit('draw_card', { roomID: myRoom, cardIndex: index });
            isMyTurn = false; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        }
    </script>
</body>
</html>