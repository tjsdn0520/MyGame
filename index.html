<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Joker Game (4 Players)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #27ae60; color: white; font-family: 'Arial', sans-serif; text-align: center; margin: 0; overflow: hidden; }
        h2 { margin: 10px; text-shadow: 1px 1px 2px black; }
        
        /* í™”ë©´ ì „í™˜ */
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; }
        .active { display: flex; }

        /* ëŒ€ê¸° í™”ë©´ */
        .loader { font-size: 50px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ê²Œì„ í…Œì´ë¸” ë ˆì´ì•„ì›ƒ */
        #game-table { 
            position: relative; width: 100%; height: 100%; max-width: 800px; margin: 0 auto; 
        }
        
        .player-area { position: absolute; width: 200px; transition: 0.3s; }
        /* ìœ„ì¹˜ ë°°ì¹˜ (í•˜ë‹¨: ë‚˜, ì¢Œ/ìš°/ìƒ: ìƒëŒ€) */
        #p-me    { bottom: 20px; left: 50%; transform: translateX(-50%); } 
        #p-next  { right: 20px; top: 50%; transform: translateY(-50%); } /* ë‚´ ë‹¤ìŒ ì‚¬ëŒ (ì˜¤ë¥¸ìª½) */
        #p-top   { top: 20px; left: 50%; transform: translateX(-50%); } 
        #p-prev  { left: 20px; top: 50%; transform: translateY(-50%); } 

        .cards-row { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; min-height: 80px; }
        
        .card { 
            width: 50px; height: 75px; background: white; border-radius: 5px; color: black;
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); border: 2px solid #ccc;
        }
        /* ì¹´ë“œ ë’·ë©´ */
        .card.back { background: repeating-linear-gradient(45deg, #e74c3c, #e74c3c 10px, #c0392b 10px, #c0392b 20px); color: transparent; cursor: pointer; }
        .card.back:hover { transform: translateY(-10px); border-color: yellow; }
        
        .turn-indicator { border: 4px solid yellow; box-shadow: 0 0 15px yellow; border-radius: 10px; padding: 5px; background: rgba(0,0,0,0.2); }
        .nickname { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .msg-box { position: absolute; center; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>ğŸ¤¡ ì¡°ì»¤ ë½‘ê¸°</h1>
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:10px; font-size:16px;">
        <button onclick="joinGame()" style="padding:10px 20px; margin-top:10px; cursor:pointer;">ì°¸ê°€í•˜ê¸°</button>
        <p id="wait-msg" style="margin-top:20px; display:none;">4ëª…ì´ ëª¨ì¼ ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘... (<span id="count">0</span>/4)</p>
        <div id="loader" class="loader" style="display:none;">ğŸƒ</div>
    </div>

    <div id="screen-game" class="screen" style="display:none;">
        <div id="game-table">
            <div class="msg-box" id="status-msg">ê²Œì„ ì‹œì‘!</div>

            <div id="p-top" class="player-area">
                <div class="nickname" id="name-top">Player 2</div>
                <div class="cards-row" id="hand-top"></div>
            </div>
            <div id="p-prev" class="player-area"> <div class="nickname" id="name-prev">Player 3</div>
                <div class="cards-row" id="hand-prev"></div>
            </div>
            <div id="p-next" class="player-area"> <div class="nickname" id="name-next">Player 1</div>
                <div class="cards-row" id="hand-next"></div>
            </div>

            <div id="p-me" class="player-area">
                <div class="nickname" id="name-me">ë‚˜</div>
                <div class="cards-row" id="hand-me"></div>
            </div>
        </div>
    </div>

    <div id="screen-end" class="screen">
        <h1 style="font-size: 50px;">ê²Œì„ ì¢…ë£Œ</h1>
        <h2 id="loser-name" style="color: yellow;">íŒ¨ë°°ì: ???</h2>
        <button onclick="location.reload()" style="padding:15px 30px; margin-top:20px;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <script>
        const socket = io();
        let myRoom = null;
        let myIndex = -1; // 0~3
        let playerNames = [];
        let isMyTurn = false;

        function joinGame() {
            const nick = document.getElementById('nickname').value || 'ìµëª…';
            socket.emit('join_game', nick);
            document.getElementById('wait-msg').style.display = 'block';
            document.getElementById('loader').style.display = 'block';
            document.querySelector('button').disabled = true;
        }

        socket.on('waiting_status', (count) => {
            document.getElementById('count').innerText = count;
        });

        socket.on('game_start', (data) => {
            myRoom = data.roomID;
            myIndex = data.myIndex;
            playerNames = data.players;

            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('screen-game').style.display = 'block'; // ê°•ì œ í‘œì‹œ

            // ì´ë¦„ ë°°ì¹˜ (ë‚˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íšŒì „)
            // myIndexê°€ 0ì´ë©´: Next=1, Top=2, Prev=3
            const nextIdx = (myIndex + 1) % 4;
            const topIdx = (myIndex + 2) % 4;
            const prevIdx = (myIndex + 3) % 4;

            document.getElementById('name-me').innerText = playerNames[myIndex] + " (ë‚˜)";
            document.getElementById('name-next').innerText = playerNames[nextIdx] + " (Target)";
            document.getElementById('name-top').innerText = playerNames[topIdx];
            document.getElementById('name-prev').innerText = playerNames[prevIdx];
        });

        socket.on('state_update', (data) => {
            isMyTurn = (data.turnIndex === myIndex);
            
            // ìƒíƒœ ë©”ì‹œì§€
            if(isMyTurn) document.getElementById('status-msg').innerText = "ë‚´ ì°¨ë¡€! ì˜¤ë¥¸ìª½ í”Œë ˆì´ì–´ ì¹´ë“œë¥¼ ë½‘ìœ¼ì„¸ìš”.";
            else document.getElementById('status-msg').innerText = `${playerNames[data.turnIndex]}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.`;

            // í„´ í‘œì‹œ (í…Œë‘ë¦¬)
            document.querySelectorAll('.player-area').forEach(el => el.classList.remove('turn-indicator'));
            if(isMyTurn) document.getElementById('p-me').classList.add('turn-indicator');
            else {
                // ë‹¤ë¥¸ ì‚¬ëŒ í„´ í‘œì‹œ ë¡œì§
                const nextIdx = (myIndex + 1) % 4;
                const topIdx = (myIndex + 2) % 4;
                const prevIdx = (myIndex + 3) % 4;
                
                if(data.turnIndex === nextIdx) document.getElementById('p-next').classList.add('turn-indicator');
                if(data.turnIndex === topIdx) document.getElementById('p-top').classList.add('turn-indicator');
                if(data.turnIndex === prevIdx) document.getElementById('p-prev').classList.add('turn-indicator');
            }

            // ë‚´ ì¹´ë“œ ê·¸ë¦¬ê¸°
            const myHandDiv = document.getElementById('hand-me');
            myHandDiv.innerHTML = '';
            data.myHand.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerText = card;
                if(card === 'ğŸ¤¡') div.style.color = 'red';
                myHandDiv.appendChild(div);
            });

            // ìƒëŒ€ë°© ì¹´ë“œ ê·¸ë¦¬ê¸° (ë’·ë©´, ê°œìˆ˜ë§Œí¼)
            renderOpponentHand('hand-next', data.playerCounts[(myIndex + 1) % 4], isMyTurn); // isMyTurnì¼ ë•Œë§Œ í´ë¦­ ê°€ëŠ¥
            renderOpponentHand('hand-top', data.playerCounts[(myIndex + 2) % 4], false);
            renderOpponentHand('hand-prev', data.playerCounts[(myIndex + 3) % 4], false);
        });

        socket.on('action_log', (data) => {
            // ëˆ„ê°€ ë½‘ì•˜ëŠ”ì§€ ì•Œë¦¼ (ì ê¹ ë³´ì—¬ì£¼ê³  ì‚¬ë¼ì§)
            const msgBox = document.getElementById('status-msg');
            msgBox.innerText = data.msg;
        });

        socket.on('game_over', (data) => {
            document.getElementById('screen-game').style.display = 'none';
            document.getElementById('screen-end').classList.add('active');
            document.getElementById('loser-name').innerText = `íŒ¨ë°°ì: ${data.loser} (ì¡°ì»¤ ë³´ìœ )`;
        });

        function renderOpponentHand(elementId, count, clickable) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = 'card back';
                div.innerText = "?";
                if(clickable) {
                    div.onclick = () => pickCard(i); // í´ë¦­ ì´ë²¤íŠ¸
                    div.style.cursor = 'pointer';
                } else {
                    div.style.cursor = 'default';
                }
                container.appendChild(div);
            }
        }

        function pickCard(index) {
            if(!isMyTurn) return;
            socket.emit('draw_card', { roomID: myRoom, cardIndex: index });
            isMyTurn = false; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        }
    </script>
</body>
</html>